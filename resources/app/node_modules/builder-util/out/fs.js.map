{"version":3,"sources":["../src/fs.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { access, chmod, copyFile as _nodeCopyFile, createReadStream, createWriteStream, ensureDir, link, lstat, readdir, readlink, stat, Stats, symlink, unlink, writeFile } from \"fs-extra-p\"\nimport * as path from \"path\"\nimport Mode from \"stat-mode\"\nimport { log } from \"./log\"\nimport { orNullIfFileNotExist } from \"./promise\"\n\nexport const MAX_FILE_REQUESTS = 8\nexport const CONCURRENCY = {concurrency: MAX_FILE_REQUESTS}\n\nexport type AfterCopyFileTransformer = (file: string) => Promise<void>\n\nexport class CopyFileTransformer {\n  constructor(public readonly afterCopyTransformer: AfterCopyFileTransformer) {\n  }\n}\n\nexport type FileTransformer = (file: string) => Promise<null | string | Buffer | CopyFileTransformer> | null | string | Buffer | CopyFileTransformer\nexport type Filter = (file: string, stat: Stats) => boolean\n\nexport function unlinkIfExists(file: string) {\n  return unlink(file)\n    .catch(() => {/* ignore */})\n}\n\nexport async function statOrNull(file: string): Promise<Stats | null> {\n  return orNullIfFileNotExist(stat(file))\n}\n\nexport async function exists(file: string): Promise<boolean> {\n  try {\n    await access(file)\n    return true\n  }\n  catch (e) {\n    return false\n  }\n}\n\nexport interface FileConsumer {\n  consume(file: string, fileStat: Stats, parent: string, siblingNames: Array<string>): any\n\n  /**\n   * @default false\n   */\n  isIncludeDir?: boolean\n}\n\n/**\n * Returns list of file paths (system-dependent file separator)\n */\nexport async function walk(initialDirPath: string, filter?: Filter | null, consumer?: FileConsumer): Promise<Array<string>> {\n  let result: Array<string> = []\n  const queue: Array<string> = [initialDirPath]\n  let addDirToResult = false\n  const isIncludeDir = consumer == null ? false : consumer.isIncludeDir === true\n  while (queue.length > 0) {\n    const dirPath = queue.pop()!\n    if (isIncludeDir) {\n      if (addDirToResult) {\n        result.push(dirPath)\n      }\n      else {\n        addDirToResult = true\n      }\n    }\n\n    const childNames = await readdir(dirPath)\n    childNames.sort()\n\n    let nodeModuleContent: Array<string> | null = null\n\n    const dirs: Array<string> = []\n    // our handler is async, but we should add sorted files, so, we add file to result not in the mapper, but after map\n    const sortedFilePaths = await BluebirdPromise.map(childNames, name => {\n      if (name === \".DS_Store\" || name === \".gitkeep\") {\n        return null\n      }\n\n      const filePath = dirPath + path.sep + name\n      return lstat(filePath)\n        .then(stat => {\n          if (filter != null && !filter(filePath, stat)) {\n            return null\n          }\n\n          const consumerResult = consumer == null ? null : consumer.consume(filePath, stat, dirPath, childNames)\n          if (consumerResult === false) {\n            return null\n          }\n          else if (consumerResult == null || !(\"then\" in consumerResult)) {\n            if (stat.isDirectory()) {\n              dirs.push(name)\n              return null\n            }\n            else {\n              return filePath\n            }\n          }\n          else {\n            return (consumerResult as Promise<any>)\n              .then((it): any => {\n                if (it != null && Array.isArray(it)) {\n                  nodeModuleContent = it\n                  return null\n                }\n\n                // asarUtil can return modified stat (symlink handling)\n                if ((it != null && \"isDirectory\" in it ? (it as Stats) : stat).isDirectory()) {\n                  dirs.push(name)\n                  return null\n                }\n                else {\n                  return filePath\n                }\n              })\n          }\n        })\n    }, CONCURRENCY)\n\n    for (const child of sortedFilePaths) {\n      if (child != null) {\n        result.push(child)\n      }\n    }\n\n    dirs.sort()\n    for (const child of dirs) {\n      queue.push(dirPath + path.sep + child)\n    }\n\n    if (nodeModuleContent != null) {\n      result = result.concat(nodeModuleContent)\n    }\n  }\n\n  return result\n}\n\nconst _isUseHardLink = process.platform !== \"win32\" && process.env.USE_HARD_LINKS !== \"false\" && (require(\"is-ci\") || process.env.USE_HARD_LINKS === \"true\")\n\nexport function copyFile(src: string, dest: string, isEnsureDir = true) {\n  return (isEnsureDir ? ensureDir(path.dirname(dest)) : Promise.resolve())\n    .then(() => copyOrLinkFile(src, dest, null, false))\n}\n\n/**\n * Hard links is used if supported and allowed.\n * File permission is fixed — allow execute for all if owner can, allow read for all if owner can.\n *\n * ensureDir is not called, dest parent dir must exists\n */\nexport function copyOrLinkFile(src: string, dest: string, stats?: Stats | null, isUseHardLink?: boolean, exDevErrorHandler?: (() => boolean) | null): Promise<any> {\n  if (isUseHardLink === undefined) {\n    isUseHardLink = _isUseHardLink\n  }\n\n  if (stats != null) {\n    const originalModeNumber = stats.mode\n    const mode = new Mode(stats)\n    if (mode.owner.execute) {\n      mode.group.execute = true\n      mode.others.execute = true\n    }\n\n    mode.group.read = true\n    mode.others.read = true\n\n    if (originalModeNumber !== stats.mode) {\n      if (log.isDebugEnabled) {\n        const oldMode = new Mode({mode: originalModeNumber})\n        log.debug({file: dest, oldMode, mode}, \"permissions fixed from\")\n      }\n\n      // https://helgeklein.com/blog/2009/05/hard-links-and-permissions-acls/\n      // Permissions on all hard links to the same data on disk are always identical. The same applies to attributes.\n      // That means if you change the permissions/owner/attributes on one hard link, you will immediately see the changes on all other hard links.\n      if (isUseHardLink) {\n        isUseHardLink = false\n        log.debug({dest}, \"copied, but not linked, because file permissions need to be fixed\")\n      }\n    }\n  }\n\n  if (isUseHardLink) {\n    return link(src, dest)\n      .catch(e => {\n        if (e.code === \"EXDEV\") {\n          const isLog = exDevErrorHandler == null ? true : exDevErrorHandler()\n          if (isLog && log.isDebugEnabled) {\n            log.debug({error: e.message}, \"cannot copy using hard link\")\n          }\n          return doCopyFile(src, dest, stats)\n        }\n        else {\n          throw e\n        }\n      })\n  }\n  return doCopyFile(src, dest, stats)\n}\n\nfunction doCopyFile(src: string, dest: string, stats: Stats | null | undefined): Promise<any> {\n  if (_nodeCopyFile == null) {\n    return new Promise((resolve, reject) => {\n      const reader = createReadStream(src)\n      const writer = createWriteStream(dest, stats == null ? undefined : {mode: stats!!.mode})\n      reader.on(\"error\", reject)\n      writer.on(\"error\", reject)\n      writer.on(\"open\", () => {\n        reader.pipe(writer)\n      })\n      writer.once(\"close\", resolve)\n    })\n  }\n\n  // node 8.5.0+\n  const promise = _nodeCopyFile(src, dest)\n  if (stats == null) {\n    return promise\n  }\n\n  return promise\n    .then(() => chmod(dest, stats.mode))\n}\n\nexport class FileCopier {\n  isUseHardLink: boolean\n\n  constructor(private readonly isUseHardLinkFunction?: ((file: string) => boolean) | null, private readonly transformer?: FileTransformer | null) {\n    if (isUseHardLinkFunction === USE_HARD_LINKS) {\n      this.isUseHardLink = true\n    }\n    else {\n      this.isUseHardLink = _isUseHardLink && isUseHardLinkFunction !== DO_NOT_USE_HARD_LINKS\n    }\n  }\n\n  async copy(src: string, dest: string, stat: Stats | undefined) {\n    let afterCopyTransformer: AfterCopyFileTransformer | null = null\n    if (this.transformer != null && stat != null && stat.isFile()) {\n      let data = this.transformer(src)\n      if (data != null) {\n        if (typeof data === \"object\" && \"then\" in data) {\n          data = await data\n        }\n\n        if (data != null) {\n          if (data instanceof CopyFileTransformer) {\n            afterCopyTransformer = data.afterCopyTransformer\n          }\n          else {\n            await writeFile(dest, data)\n            return\n          }\n        }\n      }\n    }\n\n    const isUseHardLink = afterCopyTransformer == null && ((!this.isUseHardLink || this.isUseHardLinkFunction == null) ? this.isUseHardLink : this.isUseHardLinkFunction(dest))\n    await copyOrLinkFile(src, dest, stat, isUseHardLink, isUseHardLink ? () => {\n      // files are copied concurrently, so, we must not check here currentIsUseHardLink — our code can be executed after that other handler will set currentIsUseHardLink to false\n      if (this.isUseHardLink) {\n        this.isUseHardLink = false\n        return true\n      }\n      else {\n        return false\n      }\n    } : null)\n\n    if (afterCopyTransformer != null) {\n      await afterCopyTransformer(dest)\n    }\n  }\n}\n\nexport interface CopyDirOptions {\n  filter?: Filter | null\n  transformer?: FileTransformer | null\n  isUseHardLink?: ((file: string) => boolean) | null\n}\n\n/**\n * Empty directories is never created.\n * Hard links is used if supported and allowed.\n */\nexport function copyDir(src: string, destination: string, options: CopyDirOptions = {}): Promise<any> {\n  const fileCopier = new FileCopier(options.isUseHardLink, options.transformer)\n\n  if (log.isDebugEnabled) {\n    log.debug({src, destination}, `copying${fileCopier.isUseHardLink ? \" using hard links\" : \"\"}`)\n  }\n\n  const createdSourceDirs = new Set<string>()\n  const links: Array<Link> = []\n  return walk(src, options.filter, {\n    consume: async (file, stat, parent) => {\n      if (!stat.isFile() && !stat.isSymbolicLink()) {\n        return\n      }\n\n      if (!createdSourceDirs.has(parent)) {\n        await ensureDir(parent.replace(src, destination))\n        createdSourceDirs.add(parent)\n      }\n\n      const destFile = file.replace(src, destination)\n      if (stat.isFile()) {\n        await fileCopier.copy(file, destFile, stat)\n      }\n      else {\n        links.push({file: destFile, link: await readlink(file)})\n      }\n    }\n  })\n    .then(() => BluebirdPromise.map(links, it => symlink(it.link, it.file), CONCURRENCY))\n}\n\nexport const DO_NOT_USE_HARD_LINKS = (file: string) => false\nexport const USE_HARD_LINKS = (file: string) => true\n\nexport interface Link {\n  readonly link: string,\n  readonly file: string\n}"],"sourceRoot":""}
