{"version":3,"sources":["../src/dmg.ts"],"names":[],"mappings":"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","sourcesContent":["import { Arch, AsyncTaskManager, exec, InvalidConfigurationError, isEmptyOrSpaces, log, spawn, deepAssign, executeAppBuilder } from \"builder-util\"\nimport { CancellationToken } from \"builder-util-runtime\"\nimport { copyDir, copyFile, exists, statOrNull } from \"builder-util/out/fs\"\nimport { addLicenseToDmg } from \"./dmgLicense\"\nimport { applyProperties, attachAndExecute, computeBackground, computeBackgroundColor, detach, transformBackgroundFileIfNeed } from \"./dmgUtil\"\nimport { stat } from \"fs-extra-p\"\nimport * as path from \"path\"\nimport sanitizeFileName from \"sanitize-filename\"\nimport { findIdentity, isSignAllowed } from \"app-builder-lib/out/codeSign/macCodeSign\"\nimport { Target, DmgOptions } from \"app-builder-lib\"\nimport MacPackager from \"app-builder-lib/out/macPackager\"\nimport { createBlockmap } from \"app-builder-lib/out/targets/differentialUpdateInfoBuilder\"\n\nexport class DmgTarget extends Target {\n  readonly options: DmgOptions = this.packager.config.dmg || Object.create(null)\n\n  constructor(private readonly packager: MacPackager, readonly outDir: string) {\n    super(\"dmg\")\n  }\n\n  async build(appPath: string, arch: Arch) {\n    const packager = this.packager\n    // tslint:disable-next-line:no-invalid-template-strings\n    const artifactName = packager.expandArtifactNamePattern(packager.config.dmg, \"dmg\", null, \"${productName}-\" + (packager.platformSpecificBuildOptions.bundleShortVersion || \"${version}\") + \".${ext}\")\n    const artifactPath = path.join(this.outDir, artifactName)\n    await packager.info.callArtifactBuildStarted({\n      targetPresentableName: \"DMG\",\n      file: artifactPath,\n      arch,\n    })\n\n    const specification = await this.computeDmgOptions()\n    const volumeName = sanitizeFileName(this.computeVolumeName(specification.title))\n\n    const tempDmg = await createStageDmg(await packager.getTempFile(\".dmg\"), appPath, volumeName)\n\n    // https://github.com/electron-userland/electron-builder/issues/2115\n    const backgroundFile = specification.background == null ? null : await transformBackgroundFileIfNeed(specification.background, packager.info.tempDirManager)\n    const finalSize = await computeAssetSize(packager.info.cancellationToken, tempDmg, specification, backgroundFile)\n    await exec(\"hdiutil\", [\"resize\", \"-size\", finalSize.toString(), tempDmg])\n\n    const volumePath = path.join(\"/Volumes\", volumeName)\n    if (await exists(volumePath)) {\n      log.debug({volumePath}, \"unmounting previous disk image\")\n      await detach(volumePath)\n    }\n\n    if (!await attachAndExecute(tempDmg, true, () => customizeDmg(volumePath, specification, packager, backgroundFile))) {\n      return\n    }\n\n    // dmg file must not exist otherwise hdiutil failed (https://github.com/electron-userland/electron-builder/issues/1308#issuecomment-282847594), so, -ov must be specified\n    const args = [\"convert\", tempDmg, \"-ov\", \"-format\", specification.format!, \"-o\", artifactPath]\n    if (specification.format === \"UDZO\") {\n      args.push(\"-imagekey\", `zlib-level=${process.env.ELECTRON_BUILDER_COMPRESSION_LEVEL || \"9\"}`)\n    }\n    await spawn(\"hdiutil\", addLogLevel(args))\n    if (this.options.internetEnabled) {\n      await exec(\"hdiutil\", addLogLevel([\"internet-enable\"]).concat(artifactPath))\n    }\n\n    const licenseData = await addLicenseToDmg(packager, artifactPath)\n    if (packager.packagerOptions.effectiveOptionComputed != null) {\n      await packager.packagerOptions.effectiveOptionComputed({licenseData})\n    }\n\n    await this.signDmg(artifactPath)\n\n    const safeArtifactName = packager.computeSafeArtifactName(artifactName, \"dmg\")\n    const updateInfo = await createBlockmap(artifactPath, this, packager, safeArtifactName)\n    await packager.info.callArtifactBuildCompleted({\n      file: artifactPath,\n      safeArtifactName,\n      target: this,\n      arch,\n      packager,\n      isWriteUpdateInfo: true,\n      updateInfo,\n    })\n  }\n\n  private async signDmg(artifactPath: string) {\n    if (!isSignAllowed(false)) {\n      return\n    }\n\n    const packager = this.packager\n    const qualifier = packager.platformSpecificBuildOptions.identity\n    // explicitly disabled if set to null\n    if (qualifier === null) {\n      // macPackager already somehow handle this situation, so, here just return\n      return\n    }\n\n    const keychainName = (await packager.codeSigningInfo.value).keychainName\n    const certificateType = \"Developer ID Application\"\n    let identity = await findIdentity(certificateType, qualifier, keychainName)\n    if (identity == null) {\n      identity = await findIdentity(\"Mac Developer\", qualifier, keychainName)\n      if (identity == null) {\n        return\n      }\n    }\n\n    const args = [\"--sign\", identity.hash]\n    if (keychainName != null) {\n      args.push(\"--keychain\", keychainName)\n    }\n    args.push(artifactPath)\n    await exec(\"codesign\", args)\n  }\n\n  computeVolumeName(custom?: string | null): string {\n    const appInfo = this.packager.appInfo\n    const shortVersion = this.packager.platformSpecificBuildOptions.bundleShortVersion || appInfo.version\n\n    if (custom == null) {\n      return `${appInfo.productFilename} ${shortVersion}`\n    }\n\n    return custom\n      .replace(/\\${shortVersion}/g, shortVersion)\n      .replace(/\\${version}/g, appInfo.version)\n      .replace(/\\${name}/g, appInfo.name)\n      .replace(/\\${productName}/g, appInfo.productName)\n  }\n\n  // public to test\n  async computeDmgOptions(): Promise<DmgOptions> {\n    // appdmg\n    const appdmgWindow = (this.options.window as any) || {}\n    const oldPosition = appdmgWindow.position\n    const oldSize = appdmgWindow.size\n    const oldIconSize = (this.options as any)[\"icon-size\"]\n    const oldBackgroundColor = (this.options as any)[\"background-color\"]\n    if (oldPosition != null) {\n      log.warn({solution: \"use dmg.window\"}, \"dmg.window.position is deprecated\")\n    }\n    if (oldSize != null) {\n      log.warn({solution: \"use dmg.window\"}, \"dmg.window.size is deprecated\")\n    }\n    if (oldIconSize != null) {\n      log.warn({solution: \"use dmg.iconSize\"}, \"dmg.icon-size is deprecated\")\n    }\n    if (oldBackgroundColor != null) {\n      log.warn({solution: \"use dmg.backgroundColor\"}, \"dmg.background-color is deprecated\")\n    }\n\n    const packager = this.packager\n    const specification = deepAssign<DmgOptions>({\n        window: {\n          x: 400,\n          y: 100,\n        },\n        iconSize: oldIconSize,\n        backgroundColor: oldBackgroundColor,\n        icon: \"icon\" in this.options ? undefined : await packager.getIconPath()\n      },\n      this.options,\n      oldPosition == null ? null : {\n        window: {\n          x: oldPosition.x,\n          y: oldPosition.y,\n        }\n      },\n      oldSize == null ? null : {\n        window: {\n          width: oldSize.width,\n          height: oldSize.height,\n        }\n      })\n\n    if (specification.icon != null && isEmptyOrSpaces(specification.icon)) {\n      throw new InvalidConfigurationError(\"dmg.icon cannot be specified as empty string\")\n    }\n\n    const background = specification.background\n    if (specification.backgroundColor != null) {\n      if (background != null) {\n        throw new InvalidConfigurationError(\"Both dmg.backgroundColor and dmg.background are specified — please set the only one\")\n      }\n      specification.backgroundColor = computeBackgroundColor(specification.backgroundColor)\n    }\n    else if (background == null) {\n      specification.background = await computeBackground(packager)\n    }\n    else {\n      specification.background = path.resolve(packager.info.projectDir, background)\n    }\n\n    if (specification.format == null) {\n      if (process.env.ELECTRON_BUILDER_COMPRESSION_LEVEL != null) {\n        (specification as any).format = \"UDZO\"\n      }\n      else if (packager.compression === \"store\") {\n        (specification as any).format = \"UDRO\"\n      }\n      else {\n        (specification as any).format = packager.compression === \"maximum\" ? \"UDBZ\" : \"UDZO\"\n      }\n    }\n\n    if (specification.contents == null) {\n      specification.contents = [\n        {\n          x: 130, y: 220\n        },\n        {\n          x: 410, y: 220, type: \"link\", path: \"/Applications\"\n        }\n      ]\n    }\n    return specification\n  }\n}\n\nasync function createStageDmg(tempDmg: string, appPath: string, volumeName: string) {\n  //noinspection SpellCheckingInspection\n  const imageArgs = addLogLevel([\"create\",\n    \"-srcfolder\", appPath,\n    \"-volname\", volumeName,\n    \"-anyowners\", \"-nospotlight\",\n    \"-format\", \"UDRW\",\n  ])\n  imageArgs.push(\"-fs\", \"HFS+\", \"-fsargs\", \"-c c=64,a=16,e=16\")\n  imageArgs.push(tempDmg)\n  await spawn(\"hdiutil\", imageArgs)\n  return tempDmg\n}\n\nfunction addLogLevel(args: Array<string>): Array<string> {\n  args.push(process.env.DEBUG_DMG === \"true\" ? \"-verbose\" : \"-quiet\")\n  return args\n}\n\nasync function computeAssetSize(cancellationToken: CancellationToken, dmgFile: string, specification: DmgOptions, backgroundFile: string | null | undefined) {\n  const asyncTaskManager = new AsyncTaskManager(cancellationToken)\n  asyncTaskManager.addTask(stat(dmgFile))\n\n  if (specification.icon != null) {\n    asyncTaskManager.addTask(statOrNull(specification.icon))\n  }\n\n  if (backgroundFile != null) {\n    asyncTaskManager.addTask(stat(backgroundFile))\n  }\n\n  let result = 32 * 1024\n  for (const stat of await asyncTaskManager.awaitTasks()) {\n    if (stat != null) {\n      result += stat.size\n    }\n  }\n  return result\n}\n\nasync function customizeDmg(volumePath: string, specification: DmgOptions, packager: MacPackager, backgroundFile: string | null | undefined) {\n  const window = specification.window!\n  const env: any = {\n    ...process.env,\n    volumePath,\n    appFileName: `${packager.appInfo.productFilename}.app`,\n    iconSize: specification.iconSize || 80,\n    iconTextSize: specification.iconTextSize || 12,\n\n    windowX: window.x,\n    windowY: window.y,\n\n    VERSIONER_PERL_PREFER_32_BIT: \"true\"\n  }\n\n  if (specification.backgroundColor != null || specification.background == null) {\n    env.backgroundColor = specification.backgroundColor || \"#ffffff\"\n    env.windowWidth = (window.width || 540).toString()\n    env.windowHeight = (window.height || 380).toString()\n  }\n  else {\n    delete env.backgroundColor\n\n    if (window.width == null) {\n      delete env.windowWidth\n    }\n    else {\n      env.windowWidth = window.width.toString()\n    }\n    if (window.height == null) {\n      delete env.windowHeight\n    }\n    else {\n      env.windowHeight = window.height.toString()\n    }\n  }\n\n  const args = [\"dmg\", \"--volume\", volumePath]\n  if (specification.icon != null) {\n    args.push(\"--icon\", (await packager.getResource(specification.icon))!!)\n  }\n  if (backgroundFile != null) {\n    env.backgroundFilename = path.basename(backgroundFile)\n    args.push(\"--background\", backgroundFile)\n  }\n  await executeAppBuilder(args)\n\n  const asyncTaskManager = new AsyncTaskManager(packager.info.cancellationToken)\n  await applyProperties(await computeDmgEntries(specification, volumePath, packager, asyncTaskManager), env, asyncTaskManager, packager)\n  return packager.packagerOptions.effectiveOptionComputed == null || !(await packager.packagerOptions.effectiveOptionComputed({volumePath, specification, packager}))\n}\n\nasync function computeDmgEntries(specification: DmgOptions, volumePath: string, packager: MacPackager, asyncTaskManager: AsyncTaskManager) {\n  let result = \"\"\n  for (const c of specification.contents!!) {\n    if (c.path != null && c.path.endsWith(\".app\") && c.type !== \"link\") {\n      log.warn({path: c.path, reason: \"actual path to app will be used instead\"}, `do not specify path for application`)\n    }\n\n    const entryPath = c.path || `${packager.appInfo.productFilename}.app`\n    const entryName = c.name || path.basename(entryPath)\n    result += `&makeEntries(\"${entryName}\", Iloc_xy => [ ${c.x}, ${c.y} ]),\\n`\n\n    if (c.type === \"link\") {\n      asyncTaskManager.addTask(exec(\"ln\", [\"-s\", `/${entryPath.startsWith(\"/\") ? entryPath.substring(1) : entryPath}`, `${volumePath}/${entryName}`]))\n    }\n    // use c.path instead of entryPath (to be sure that this logic is not applied to .app bundle) https://github.com/electron-userland/electron-builder/issues/2147\n    else if (!isEmptyOrSpaces(c.path) && (c.type === \"file\" || c.type === \"dir\")) {\n      const source = await packager.getResource(c.path)\n      if (source == null) {\n        log.warn({entryPath, reason: \"doesn't exist\"}, `skipped DMG item copying`)\n        continue\n      }\n\n      const destination = `${volumePath}/${entryName}`\n      asyncTaskManager.addTask(c.type === \"dir\" || (await stat(source)).isDirectory() ? copyDir(source, destination) : copyFile(source, destination))\n    }\n  }\n  return result\n}"],"sourceRoot":""}
