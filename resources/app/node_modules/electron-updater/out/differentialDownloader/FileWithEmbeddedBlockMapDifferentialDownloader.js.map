{"version":3,"sources":["../../src/differentialDownloader/FileWithEmbeddedBlockMapDifferentialDownloader.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA,MAAM,IAAI,GAAG,OAAO,CAAC,MAAD,CAApB;;AAEM,MAAO,8CAAP,SAA8D,gDAA9D,CAAoF;AAClF,EAAA,QAAN,GAAc;AAAA;;AAAA;AACZ,YAAM,WAAW,GAAG,KAAI,CAAC,kBAAzB;AACA,YAAM,QAAQ,GAAG,WAAW,CAAC,IAA7B;AACA,YAAM,MAAM,GAAG,QAAQ,IAAI,WAAW,CAAC,YAAZ,GAA6B,CAAjC,CAAvB;AACA,MAAA,KAAI,CAAC,kBAAL,SAAgC,KAAI,CAAC,eAAL,CAAqB,MAArB,EAA6B,QAAQ,GAAG,CAAxC,CAAhC;AACA,YAAM,WAAW,GAAG,YAAY,CAAC,KAAI,CAAC,kBAAL,CAAwB,KAAxB,CAA8B,CAA9B,EAAiC,KAAI,CAAC,kBAAL,CAAwB,MAAxB,GAAiC,CAAlE,CAAD,CAAhC;AACA,YAAM,KAAI,CAAC,UAAL,QAAsB,wBAAwB,CAAC,KAAI,CAAC,OAAL,CAAa,OAAd,CAA9C,GAAsE,WAAtE,CAAN;AANY;AAOb;;AARuF;;;;AAW1F,SAAS,YAAT,CAAsB,IAAtB,EAAkC;AAChC,SAAO,IAAI,CAAC,KAAL,CAAW,IAAI,CAAC,UAAL,CAAgB,IAAhB,EAAsB;AAAC,IAAA,EAAE,EAAE;AAAL,GAAtB,CAAX,CAAP;AACD;;SAEc,wB;;;;;;4DAAf,WAAwC,IAAxC,EAAoD;AAClD,UAAM,EAAE,SAAS,sBAAK,IAAL,EAAW,GAAX,CAAjB;;AACA,QAAI;AACF,YAAM,QAAQ,GAAG,OAAO,uBAAM,EAAN,CAAP,EAAkB,IAAnC;AACA,YAAM,UAAU,GAAG,MAAM,CAAC,WAAP,CAAmB,CAAnB,CAAnB;AACA,YAAM,sBAAK,EAAL,EAAS,UAAT,EAAqB,CAArB,EAAwB,UAAU,CAAC,MAAnC,EAA2C,QAAQ,GAAG,UAAU,CAAC,MAAjE,CAAN;AAEA,YAAM,UAAU,GAAG,MAAM,CAAC,WAAP,CAAmB,UAAU,CAAC,YAAX,CAAwB,CAAxB,CAAnB,CAAnB;AACA,YAAM,sBAAK,EAAL,EAAS,UAAT,EAAqB,CAArB,EAAwB,UAAU,CAAC,MAAnC,EAA2C,QAAQ,GAAG,UAAU,CAAC,MAAtB,GAA+B,UAAU,CAAC,MAArF,CAAN;AACA,YAAM,uBAAM,EAAN,CAAN;AAEA,aAAO,YAAY,CAAC,UAAD,CAAnB;AACD,KAVD,CAWA,OAAO,CAAP,EAAU;AACR,YAAM,uBAAM,EAAN,CAAN;AACA,YAAM,CAAN;AACD;AACF,G","sourcesContent":["import { BlockMap } from \"builder-util-runtime/out/blockMapApi\"\nimport { close, fstat, open, read } from \"fs-extra-p\"\nimport { DifferentialDownloader } from \"./DifferentialDownloader\"\n\nconst pako = require(\"pako\")\n\nexport class FileWithEmbeddedBlockMapDifferentialDownloader extends DifferentialDownloader {\n  async download() {\n    const packageInfo = this.blockAwareFileInfo\n    const fileSize = packageInfo.size!!\n    const offset = fileSize - (packageInfo.blockMapSize!! + 4)\n    this.fileMetadataBuffer = await this.readRemoteBytes(offset, fileSize - 1)\n    const newBlockMap = readBlockMap(this.fileMetadataBuffer.slice(0, this.fileMetadataBuffer.length - 4))\n    await this.doDownload(await readEmbeddedBlockMapData(this.options.oldFile), newBlockMap)\n  }\n}\n\nfunction readBlockMap(data: Buffer): BlockMap {\n  return JSON.parse(pako.inflateRaw(data, {to: \"string\"}))\n}\n\nasync function readEmbeddedBlockMapData(file: string): Promise<BlockMap> {\n  const fd = await open(file, \"r\")\n  try {\n    const fileSize = (await fstat(fd)).size\n    const sizeBuffer = Buffer.allocUnsafe(4)\n    await read(fd, sizeBuffer, 0, sizeBuffer.length, fileSize - sizeBuffer.length)\n\n    const dataBuffer = Buffer.allocUnsafe(sizeBuffer.readUInt32BE(0))\n    await read(fd, dataBuffer, 0, dataBuffer.length, fileSize - sizeBuffer.length - dataBuffer.length)\n    await close(fd)\n\n    return readBlockMap(dataBuffer)\n  }\n  catch (e) {\n    await close(fd)\n    throw e\n  }\n}"],"sourceRoot":""}
