{"version":3,"sources":["../../src/targets/MsiTarget.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { Arch, log, deepAssign } from \"builder-util\"\nimport { UUID } from \"builder-util-runtime\"\nimport { getBinFromGithub } from \"../binDownload\"\nimport { walk } from \"builder-util/out/fs\"\nimport { createHash } from \"crypto\"\nimport * as ejs from \"ejs\"\nimport { readFile, writeFile } from \"fs-extra-p\"\nimport { Lazy } from \"lazy-val\"\nimport * as path from \"path\"\nimport { MsiOptions } from \"../\"\nimport { Target } from \"../core\"\nimport { DesktopShortcutCreationPolicy, FinalCommonWindowsInstallerOptions, getEffectiveOptions } from \"../options/CommonWindowsInstallerConfiguration\"\nimport { getTemplatePath } from \"../util/pathManager\"\nimport { VmManager } from \"../vm/vm\"\nimport { WineVmManager } from \"../vm/WineVm\"\nimport { WinPackager } from \"../winPackager\"\nimport { createStageDir, getWindowsInstallationDirName } from \"./targetUtil\"\n\nconst ELECTRON_BUILDER_UPGRADE_CODE_NS_UUID = UUID.parse(\"d752fe43-5d44-44d5-9fc9-6dd1bf19d5cc\")\nconst ROOT_DIR_ID = \"APPLICATIONFOLDER\"\n\nconst ASSISTED_UI_FILE_NAME = \"WixUI_Assisted.wxs\"\n\nconst projectTemplate = new Lazy<(data: any) => string>(async () => {\n  const template = (await readFile(path.join(getTemplatePath(\"msi\"), \"template.xml\"), \"utf8\"))\n    .replace(/{{/g, \"<%\")\n    .replace(/}}/g, \"%>\")\n    .replace(/\\${([^}]+)}/g, \"<%=$1%>\")\n  return ejs.compile(template)\n})\n\n// WiX doesn't support Mono, so, dontnet462 is required to be installed for wine (preinstalled in our bundled wine)\nexport default class MsiTarget extends Target {\n  private readonly vm = process.platform === \"win32\" ? new VmManager() : new WineVmManager()\n\n  readonly options: MsiOptions = deepAssign(this.packager.platformSpecificBuildOptions, this.packager.config.msi)\n\n  constructor(private readonly packager: WinPackager, readonly outDir: string) {\n    super(\"msi\")\n  }\n\n  async build(appOutDir: string, arch: Arch) {\n    const packager = this.packager\n    const artifactName = packager.expandArtifactBeautyNamePattern(this.options, \"msi\", arch)\n    const artifactPath = path.join(this.outDir, artifactName)\n    await packager.info.callArtifactBuildStarted({\n      targetPresentableName: \"MSI\",\n      file: artifactPath,\n      arch,\n    })\n\n    const stageDir = await createStageDir(this, packager, arch)\n    const vm = this.vm\n\n    const commonOptions = getEffectiveOptions(this.options, this.packager)\n\n    if (commonOptions.isAssisted) {\n      // F*** *** ***  ***  ***  ***  ***  ***  ***  ***  ***  ***  *** WiX  ***  ***  ***  ***  ***  ***  ***  ***  ***\n      // cannot understand how to set MSIINSTALLPERUSER on radio box change. In any case installed per user.\n      log.warn(`MSI DOESN'T SUPPORT assisted installer. Please use NSIS instead.`)\n    }\n\n    const projectFile = stageDir.getTempFile(\"project.wxs\")\n    const objectFiles = [\"project.wixobj\"]\n    const uiFile = commonOptions.isAssisted ?  stageDir.getTempFile(ASSISTED_UI_FILE_NAME) : null\n    await writeFile(projectFile, await this.writeManifest(appOutDir, arch, commonOptions))\n    if (uiFile !== null) {\n      await writeFile(uiFile, await readFile(path.join(getTemplatePath(\"msi\"), ASSISTED_UI_FILE_NAME), \"utf8\"))\n      objectFiles.push(ASSISTED_UI_FILE_NAME.replace(\".wxs\", \".wixobj\"))\n    }\n\n    // noinspection SpellCheckingInspection\n    const vendorPath = await getBinFromGithub(\"wix\", \"4.0.0.5512.2\", \"/X5poahdCc3199Vt6AP7gluTlT1nxi9cbbHhZhCMEu+ngyP1LiBMn+oZX7QAZVaKeBMc2SjVp7fJqNLqsUnPNQ==\")\n\n    // noinspection SpellCheckingInspection\n    const candleArgs = [\n      \"-arch\", arch === Arch.ia32 ? \"x86\" : (arch === Arch.armv7l ? \"arm\" : \"x64\"),\n      `-dappDir=${vm.toVmFile(appOutDir)}`,\n    ].concat(this.getCommonWixArgs())\n    candleArgs.push(\"project.wxs\")\n    if (uiFile !== null) {\n      candleArgs.push(ASSISTED_UI_FILE_NAME)\n    }\n    await vm.exec(vm.toVmFile(path.join(vendorPath, \"candle.exe\")), candleArgs, {\n      cwd: stageDir.dir,\n    })\n\n    await this.light(objectFiles, vm, artifactPath, appOutDir, vendorPath, stageDir.dir)\n\n    await stageDir.cleanup()\n\n    await packager.sign(artifactPath)\n\n    await packager.info.callArtifactBuildCompleted({\n      file: artifactPath,\n      packager,\n      arch,\n      safeArtifactName: packager.computeSafeArtifactName(artifactName, \"msi\"),\n      target: this,\n      isWriteUpdateInfo: false,\n    })\n  }\n\n  private async light(objectFiles: Array<string>, vm: VmManager, artifactPath: string, appOutDir: string, vendorPath: string, tempDir: string) {\n    // noinspection SpellCheckingInspection\n    const lightArgs = [\n      \"-out\", vm.toVmFile(artifactPath),\n      \"-v\",\n      // https://github.com/wixtoolset/issues/issues/5169\n      \"-spdb\",\n      // https://sourceforge.net/p/wix/bugs/2405/\n      // error LGHT1076 : ICE61: This product should remove only older versions of itself. The Maximum version is not less than the current product. (1.1.0.42 1.1.0.42)\n      \"-sw1076\",\n      `-dappDir=${vm.toVmFile(appOutDir)}`,\n      // \"-dcl:high\",\n    ].concat(this.getCommonWixArgs())\n\n    // http://windows-installer-xml-wix-toolset.687559.n2.nabble.com/Build-3-5-2229-0-give-me-the-following-error-error-LGHT0216-An-unexpected-Win32-exception-with-errorn-td5707443.html\n    if (process.platform !== \"win32\") {\n      // noinspection SpellCheckingInspection\n      lightArgs.push(\"-sval\")\n    }\n\n    if (this.options.oneClick === false) {\n      lightArgs.push(\"-ext\", \"WixUIExtension\")\n    }\n\n    // objectFiles - only filenames, we set current directory to our temp stage dir\n    lightArgs.push(...objectFiles)\n    await vm.exec(vm.toVmFile(path.join(vendorPath, \"light.exe\")), lightArgs, {\n      cwd: tempDir,\n    })\n  }\n\n  private getCommonWixArgs() {\n    const args: Array<string> = [\"-pedantic\"]\n    if (this.options.warningsAsErrors !== false) {\n      args.push(\"-wx\")\n    }\n    return args\n  }\n\n  private async writeManifest(appOutDir: string, arch: Arch, commonOptions: FinalCommonWindowsInstallerOptions) {\n    const appInfo = this.packager.appInfo\n    const {files, dirs} = await this.computeFileDeclaration(appOutDir)\n\n    const companyName = appInfo.companyName\n    if (!companyName) {\n      log.warn(`Manufacturer is not set for MSI — please set \"author\" in the package.json`)\n    }\n\n    const compression = this.packager.compression\n    const options = this.options\n    const iconPath = await this.packager.getIconPath()\n    return (await projectTemplate.value)({\n      ...commonOptions,\n      isCreateDesktopShortcut: commonOptions.isCreateDesktopShortcut !== DesktopShortcutCreationPolicy.NEVER,\n      isRunAfterFinish: options.runAfterFinish !== false,\n      iconPath: iconPath == null ? null : this.vm.toVmFile(iconPath),\n      compressionLevel: compression === \"store\" ? \"none\" : \"high\",\n      version: appInfo.getVersionInWeirdWindowsForm(),\n      productName: appInfo.productName,\n      upgradeCode: (options.upgradeCode || UUID.v5(appInfo.id, ELECTRON_BUILDER_UPGRADE_CODE_NS_UUID)).toUpperCase(),\n      manufacturer: companyName || appInfo.productName,\n      appDescription: appInfo.description,\n      // https://stackoverflow.com/questions/1929038/compilation-error-ice80-the-64bitcomponent-uses-32bitdirectory\n      programFilesId: arch === Arch.x64 ? \"ProgramFiles64Folder\" : \"ProgramFilesFolder\",\n      // wix in the name because special wix format can be used in the name\n      installationDirectoryWixName: getWindowsInstallationDirName(appInfo, commonOptions.isPerMachine === true),\n      dirs,\n      files,\n    })\n  }\n\n  private async computeFileDeclaration(appOutDir: string) {\n    const appInfo = this.packager.appInfo\n    let isRootDirAddedToRemoveTable = false\n    const dirNames = new Set<string>()\n    const dirs: Array<string> = []\n    const fileSpace = \" \".repeat(6)\n    const commonOptions = getEffectiveOptions(this.options, this.packager)\n    const files = await BluebirdPromise.map(walk(appOutDir), file => {\n      const packagePath = file.substring(appOutDir.length + 1)\n\n      const lastSlash = packagePath.lastIndexOf(path.sep)\n      const fileName = lastSlash > 0 ? packagePath.substring(lastSlash + 1) : packagePath\n      let directoryId: string | null = null\n      let dirName = \"\"\n      // Wix Directory.FileSource doesn't work - https://stackoverflow.com/questions/21519388/wix-filesource-confusion\n      if (lastSlash > 0) {\n        // This Name attribute may also define multiple directories using the inline directory syntax.\n        // For example, \"ProgramFilesFolder:\\My Company\\My Product\\bin\" would create a reference to a Directory element with Id=\"ProgramFilesFolder\" then create directories named \"My Company\" then \"My Product\" then \"bin\" nested beneath each other.\n        // This syntax is a shortcut to defining each directory in an individual Directory element.\n        dirName = packagePath.substring(0, lastSlash)\n        // https://github.com/electron-userland/electron-builder/issues/3027\n        directoryId = \"d\" + createHash(\"md5\").update(dirName).digest(\"base64\").replace(/\\//g, \"_\").replace(/\\+/g, \".\").replace(/=+$/, \"\")\n        if (!dirNames.has(dirName)) {\n          dirNames.add(dirName)\n          dirs.push(`<Directory Id=\"${directoryId}\" Name=\"${ROOT_DIR_ID}:\\\\${dirName.replace(/\\//g, \"\\\\\")}\\\\\"/>`)\n        }\n      }\n      else if (!isRootDirAddedToRemoveTable) {\n        isRootDirAddedToRemoveTable = true\n      }\n\n      // since RegistryValue can be part of Component, *** *** *** *** *** *** *** *** *** wix cannot auto generate guid\n      // https://stackoverflow.com/questions/1405100/change-my-component-guid-in-wix\n      let result = `<Component${directoryId === null ? \"\" : ` Directory=\"${directoryId}\"`}>`\n      result += `\\n${fileSpace}  <File Name=\"${fileName}\" Source=\"$(var.appDir)${path.sep}${packagePath}\" ReadOnly=\"yes\" KeyPath=\"yes\"`\n      const isMainExecutable = packagePath === `${appInfo.productFilename}.exe`\n      if (isMainExecutable) {\n        result += ' Id=\"mainExecutable\"'\n      }\n      else if (directoryId === null) {\n        result += ` Id=\"${path.basename(packagePath)}_f\"`\n      }\n\n      const isCreateDesktopShortcut = commonOptions.isCreateDesktopShortcut !== DesktopShortcutCreationPolicy.NEVER\n      if (isMainExecutable && (isCreateDesktopShortcut || commonOptions.isCreateStartMenuShortcut)) {\n        result += `>\\n`\n        const shortcutName = commonOptions.shortcutName\n        if (isCreateDesktopShortcut) {\n          result += `${fileSpace}  <Shortcut Id=\"desktopShortcut\" Directory=\"DesktopFolder\" Name=\"${shortcutName}\" WorkingDirectory=\"APPLICATIONFOLDER\" Advertise=\"yes\" Icon=\"icon.ico\"/>\\n`\n        }\n\n        const hasMenuCategory = commonOptions.menuCategory != null\n        const startMenuShortcutDirectoryId = hasMenuCategory ? \"AppProgramMenuDir\" : \"ProgramMenuFolder\"\n        if (commonOptions.isCreateStartMenuShortcut) {\n          if (hasMenuCategory) {\n            dirs.push(`<Directory Id=\"${startMenuShortcutDirectoryId}\" Name=\"ProgramMenuFolder:\\\\${commonOptions.menuCategory}\\\\\"/>`)\n          }\n          result += `${fileSpace}  <Shortcut Id=\"startMenuShortcut\" Directory=\"${startMenuShortcutDirectoryId}\" Name=\"${shortcutName}\" WorkingDirectory=\"APPLICATIONFOLDER\" Advertise=\"yes\" Icon=\"icon.ico\">\\n`\n          result += `${fileSpace}    <ShortcutProperty Key=\"System.AppUserModel.ID\" Value=\"${this.packager.appInfo.id}\"/>\\n`\n          result += `${fileSpace}  </Shortcut>\\n`\n        }\n        result += `${fileSpace}</File>`\n\n        if (hasMenuCategory) {\n          result += `<RemoveFolder Id=\"${startMenuShortcutDirectoryId}\" On=\"uninstall\"/>\\n`\n        }\n      }\n      else {\n        result += `/>`\n      }\n\n      return `${result}\\n${fileSpace}</Component>`\n    })\n\n    return {dirs: listToString(dirs, 2), files: listToString(files, 3)}\n  }\n}\n\nfunction listToString(list: Array<string>, indentLevel:  number) {\n  const space = \" \".repeat(indentLevel * 2)\n  return list.join(`\\n${space}`)\n}"],"sourceRoot":""}
